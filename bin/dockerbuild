#!/bin/bash
. .env
echo 'Validating folders'
if [ ! -d "site/dbdata" ]; then
mkdir -p site/dbdata;
fi
if [ ! -d "site/ssl" ]; then
mkdir -p site/ssl;
fi
if [ ! -d "site/n8n_data" ]; then
mkdir -p site/n8n_data;
fi
echo 'Folder validation complete'
echo 'Generating SSL'
cd site/ssl;
rm *.pem;
mkcert dbadmin.test;
mkcert llm.test;
mkcert n8n.test;
echo 'Generating SSL Complete'
echo 'Building containers'	
bash init.v2.bash;

sleep 30
for DOMAINVALUE in ${STACKDOMAINS[@]}; 

do
    echo "Generating Rabbit connection configuration for "$DOMAINVALUE
	echo `docker exec -it mydev_rabbitmq rabbitmqctl add_user $DOMAINVALUE q1w2e3r4`;
    echo `docker exec -it mydev_rabbitmq rabbitmqctl add_vhost $DOMAINVALUE`;
    echo `docker exec -it mydev_rabbitmq rabbitmqctl set_permissions -p $DOMAINVALUE $DOMAINVALUE '.*' '.*' '.*'`;
done

echo "Built from docker"
